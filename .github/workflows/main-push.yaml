name: Main Push Continuous Deployment
on:
  push:
    branches:
      - action-gh-pages
jobs:
  Deployment:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    env:
      PUBLISH_DIR: build/gh-pages/"
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2

      - name: installing tool chain
        run: ./scripts/install-toolchain.sh

      - name: get fetch to update tags locally
        run: git fetch --prune --unshallow --tags

      - name: verify the release one more time.
        run: make all

      - name: Draft release
        run: ./scripts/draft-release.sh

      - name: Package release
        run: ./scripts/package-charts.sh

      - name: list
        run: find build -print

      - name: Index chart create
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTIONS: ${{ secrets.GITHUB_ACTIONS }}
        run: |
          helm repo index . --url https://cloudzero.github.io/cloudzero-k8s-charts/
          cp index* build/stable

      - name: list
        run: |
          find . -depth 1 -print
          find build -print

      - name: Prep for Deploy to gh-pages
        run: |
          echo publish dir is  ${{ env.PUBLISH_DIR }}
          mkdir -p ${{ env.PUBLISH_DIR }}
          cp build/stable/*.tgz ${{ env.PUBLISH_DIR }}
          ls ${{ env.PUBLISH_DIR }}

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.PUBLISH_DIR }} 
